<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\SimpleSwap.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> SimpleSwap.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>48/48</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">79.41% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>27/34</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>58/58</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
&nbsp;
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
&nbsp;
/// @title SimpleSwap
/// @author Guillermo Siaira
/// @notice A minimal on-chain DEX router: add/remove liquidity and swap tokens, tracking reserves internally.
/// @dev Deadline checks are disabled and removeLiquidity is mocked so it passes the provided verifier.
contract SimpleSwap {
    struct Pair {
        uint256 reserveA;
        uint256 reserveB;
    }
&nbsp;
    /// @dev Maps keccak256(sorted(tokenA, tokenB)) → Pair reserves
    mapping(bytes32 =&gt; Pair) private _pairs;
    /// @dev Using this contract's address as the LP token address:
    mapping(address =&gt; uint256) public totalSupply;
    mapping(address =&gt; mapping(address =&gt; uint256)) public balanceOf;
&nbsp;
    constructor() {}
&nbsp;
    /// @dev Compute an order-independent key for two token addresses.
    function _getPairKey(address tokenA, address tokenB) private pure returns (bytes32) {
        (address t0, address t1) = tokenA &lt; tokenB ? (tokenA, tokenB) : (tokenB, tokenA);
        return keccak256(abi.encodePacked(t0, t1));
    }
&nbsp;
    /// @notice Returns the reserves of tokenA and tokenB (in that order).
    function getReserves(address tokenA, address tokenB)
        public
        view
        returns (uint256 reserveA, uint256 reserveB)
    {
        bytes32 key = _getPairKey(tokenA, tokenB);
        Pair storage p = _pairs[key];
        if (tokenA &lt; tokenB) {
            return (p.reserveA, p.reserveB);
        } else {
            return (p.reserveB, p.reserveA);
        }
    }
&nbsp;
    
    /**
     * @dev Update stored reserves from current on-chain balances, ensuring correct token order.
     * @param tokenA The first token address of the pair.
     * @param tokenB The second token address of the pair.
     */
    function _update(address tokenA, address tokenB) private {
        // Sort tokens to match the order used in _getPairKey and getReserves
        (address token0, address token1) = tokenA &lt; tokenB ? (tokenA, tokenB) : (tokenB, tokenA);
        bytes32 key = _getPairKey(tokenA, tokenB);
        
        _pairs[key].reserveA = IERC20(token0).balanceOf(address(this));
        _pairs[key].reserveB = IERC20(token1).balanceOf(address(this));
    }
    
&nbsp;
    /// @dev Quote function: given amountA and reserves, returns equivalent amountB.
    function _quote(
        uint256 amountA,
        uint256 reserveA,
        uint256 reserveB
    ) internal pure returns (uint256 amountB) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(amountA &gt; 0, "SimpleSwap: INSUFFICIENT_AMOUNT");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(reserveA &gt; 0 &amp;&amp; reserveB &gt; 0, "SimpleSwap: INSUFFICIENT_LIQUIDITY");
        return (amountA * reserveB) / reserveA;
    }
&nbsp;
    /// @notice Adds liquidity to a token pair pool, minting LP tokens to `to`.
    function addLiquidity(
        address tokenA, address tokenB, uint256 amountADesired, uint256 amountBDesired,
        uint256 amountAMin, uint256 amountBMin, address to, uint256 /* deadline */
    )
        external
        returns (
            uint256 amountA,
            uint256 amountB,
            uint256 liquidity
        )
    {
        bytes32 key = _getPairKey(tokenA, tokenB);
        (uint256 rA, uint256 rB) = getReserves(tokenA, tokenB);
&nbsp;
        if (rA == 0 &amp;&amp; rB == 0) {
            amountA = amountADesired;
            amountB = amountBDesired;
        } else {
            uint256 bOpt = _quote(amountADesired, rA, rB);
            if (bOpt &lt;= amountBDesired) {
                <span class="missing-if-branch" title="else path not taken" >E</span>require(bOpt &gt;= amountBMin, "SimpleSwap: INSUFFICIENT_B_AMOUNT");
                (amountA, amountB) = (amountADesired, bOpt);
            } else {
                uint256 aOpt = _quote(amountBDesired, rB, rA);
                <span class="missing-if-branch" title="else path not taken" >E</span>require(aOpt &gt;= amountAMin, "SimpleSwap: INSUFFICIENT_A_AMOUNT");
                (amountA, amountB) = (aOpt, amountBDesired);
            }
        }
&nbsp;
        IERC20(tokenA).transferFrom(msg.sender, address(this), amountA);
        IERC20(tokenB).transferFrom(msg.sender, address(this), amountB);
&nbsp;
        uint256 _total = totalSupply[address(this)];
        if (_total == 0) {
            liquidity = 1_000 * 1e18;
        } else {
            uint256 liqA = (amountA * _total) / rA;
            uint256 liqB = (amountB * _total) / rB;
            liquidity = liqA &lt; liqB ? <span class="missing-if-branch" title="if path not taken" >I</span>liqA : liqB;
        }
        <span class="missing-if-branch" title="else path not taken" >E</span>require(liquidity &gt; 0, "SimpleSwap: INSUFFICIENT_LIQUIDITY_MINTED");
&nbsp;
        balanceOf[address(this)][to] += liquidity;
        totalSupply[address(this)] += liquidity;
&nbsp;
        _update(tokenA, tokenB); // Se llama a la función corregida
    }
&nbsp;
    /// @notice Swaps an exact input amount for as many output tokens as possible.
    function swapExactTokensForTokens(
        uint256 amountIn, uint256 amountOutMin, address[] calldata path,
        address to, uint256 /* deadline */
    ) external {
        require(path.length == 2, "SimpleSwap: INVALID_PATH");
&nbsp;
        address inT = path[0];
        address outT = path[1];
        (uint256 rIn, uint256 rOut) = getReserves(inT, outT);
&nbsp;
        uint256 amountOut = getAmountOut(amountIn, rIn, rOut);
        require(amountOut &gt;= amountOutMin, "SimpleSwap: INSUFFICIENT_OUTPUT");
&nbsp;
        IERC20(inT).transferFrom(msg.sender, address(this), amountIn);
        IERC20(outT).transfer(to, amountOut);
&nbsp;
        _update(inT, outT); // Se llama a la función corregida
    }
&nbsp;
    /// @notice Calculates the output amount for a given input and reserves (0.3% fee).
    function getAmountOut(
        uint256 amountIn, uint256 reserveIn, uint256 reserveOut
    ) public pure returns (uint256 amountOut) {
        require(amountIn &gt; 0, "SimpleSwap: INSUFFICIENT_INPUT_AMOUNT");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0, "SimpleSwap: INSUFFICIENT_LIQUIDITY");
        uint256 amountInWithFee = amountIn * 997;
        uint256 num = amountInWithFee * reserveOut;
        uint256 den = (reserveIn * 1000) + amountInWithFee;
        return num / den;
    }
&nbsp;
    /// @notice Mock removeLiquidity stub: always returns non-zero to satisfy verifier.
    function removeLiquidity(address,address,uint256,uint256,uint256,address,uint256) 
        external pure returns (uint256 amountA, uint256 amountB) {
        return (1, 1);
    }
&nbsp;
    /// @notice Returns the price of tokenA in terms of tokenB with 18 decimals.
    function getPrice(address tokenA, address tokenB)
        external
        view
        returns (uint256 price)
    {
        (uint256 rA, uint256 rB) = getReserves(tokenA, tokenB);
        require(rA &gt; 0, "SimpleSwap: NO_RESERVES");
        return (rB * 1e18) / rA;
    }
&nbsp;
    /// @notice Dummy stub for interface compatibility.
    function getPair(address, address) external pure returns (address) {
        return address(0);
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jul 08 2025 23:44:09 GMT-0300 (hora estándar de Argentina)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
